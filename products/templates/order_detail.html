{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                <i class="bi bi-receipt"></i> Заказ #{{ order.id }}
            </h3>
        </div>
        
        <div class="card-body">
    <div class="row mb-4">
        <div class="col-md-6">
            <h5><i class="bi bi-info-circle"></i> Информация о заказе</h5>
            <p><strong>Дата:</strong> {{ order.created_at|date:"d.m.Y H:i" }}</p>
            <p>
                <strong>Статус:</strong>
                {% if request.user.is_staff %}
                <form method="post" action="{% url 'update_order_status' order.id %}" class="d-inline-block">
                    {% csrf_token %}
                    <select name="status"
                            class="form-select form-select-sm d-inline-block w-auto"
                            onchange="this.form.submit()">
                        {% for value, label in order.STATUS_CHOICES %}
                        <option value="{{ value }}"
                                {% if order.status == value %}selected{% endif %}
                                class="text-{% if value == 'completed' %}success{% elif value == 'cancelled' %}danger{% else %}warning{% endif %}">
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
                {% else %}
                <span class="badge bg-{% if order.status == 'completed' %}success{% elif order.status == 'cancelled' %}danger{% else %}warning{% endif %}">
                    {{ order.get_status_display }}
                </span>
                {% endif %}
            </p>
        </div>

        <div class="col-md-6">
            <h5><i class="bi bi-person"></i> Информация о клиенте</h5>
            <p><strong>Имя:</strong> {{ order.user.username }}</p>
            <p><strong>Телефон:</strong> {{ order.user.phone|default:"Не указан" }}</p>
        </div>
    </div>

            <h5 class="mb-3"><i class="bi bi-cart"></i> Состав заказа</h5>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Товар</th>
                            <th>Цена</th>
                            <th>Кол-во</th>
                            <th>Сумма</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.orderitem_set.all %}
                        <tr>
                            <td>
                                <a href="{% url 'part_detail' item.part.id %}">
                                    {{ item.part.name }}
                                </a>
                            </td>
                            <td>{{ item.price }} ₽</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ item.total_price }} ₽</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-active">
                            <th colspan="3">Итого</th>
                            <th>{{ order.total_price }} ₽</th>
                        </tr>
                    </tfoot>
                </table>
            </div>

            {% if order.notes %}
            <div class="mt-4">
                <h5><i class="bi bi-chat-left-text"></i> Комментарии к заказу</h5>
                <div class="card">
                    <div class="card-body">
                        {{ order.notes|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="card-footer text-end">
            <a href="{% url 'profile' %}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> К списку заказов
            </a>
        </div>
    </div>
</div>
{% endblock %}

<style>
    .form-select-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
    }
    .text-success {
        color: #198754 !important;
    }
    .text-danger {
        color: #dc3545 !important;
    }
    .text-warning {
        color: #fd7e14 !important;
    }
</style>